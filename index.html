<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ÎåÄÎ¶¨Ï†ê Î∞©Î¨∏ ÏßÄÎèÑ (41Í∞ú)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=k8vacdhpym&submodules=geocoder"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- SheetJS for Excel -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; font-family: 'Malgun Gothic', sans-serif; }
#map { width:100vw; height:100vh; }

#progress {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,.2);
}

.action-btn {
  position:absolute;
  right:10px;
  z-index:1000;
  color:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,.2);
  cursor:pointer;
  border:none;
  font-size:14px;
  transition:.2s;
}

#download-btn {
  top:50px;
  background:#4caf50;
}

#download-btn:hover {
  background:#45a049;
}

#loading {
  position:absolute;
  top:95px;
  right:10px;
  z-index:1000;
  background:#2196f3;
  color:#fff;
  padding:8px 12px;
  border-radius:16px;
  font-size:12px;
  display:none;
}

/* ÎßêÌíçÏÑ† Ïä§ÌÉÄÏùº */
.bubble {
  position:relative;
  background:#fff;
  border:2px solid #d32f2f;
  border-radius:8px;
  padding:4px 10px;
  font-size:12px;
  font-weight:bold;
  white-space:nowrap;
  cursor:pointer;
  transition:.2s;
}

.bubble.visited {
  border-color:#1976d2;
  background-color:#e3f2fd;
  color:#1976d2;
}

.bubble:after {
  content:"";
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:-8px;
  width:0;
  height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-top:8px solid #d32f2f;
}

.bubble.visited:after {
  border-top-color:#1976d2;
}

/* Î™®Îã¨ */
#modal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  z-index:2000;
  justify-content:center;
  align-items:center;
}

#modal.show {
  display:flex;
}

#modal-content {
  background:#fff;
  border-radius:12px;
  padding:24px;
  width:90%;
  max-width:400px;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
  max-height:80vh;
  overflow-y:auto;
}

#modal-title {
  font-size:18px;
  font-weight:bold;
  margin-bottom:16px;
  color:#333;
}

.modal-section {
  margin-bottom:16px;
}

.modal-section label {
  display:block;
  font-weight:bold;
  margin-bottom:8px;
  color:#555;
}

.status-buttons {
  display:flex;
  gap:8px;
}

.status-btn {
  flex:1;
  padding:10px;
  border:2px solid #ddd;
  background:#fff;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  transition:.2s;
}

.status-btn:hover {
  background:#f5f5f5;
}

.status-btn.active.visited {
  border-color:#1976d2;
  background:#1976d2;
  color:#fff;
}

.status-btn.active.not-visited {
  border-color:#d32f2f;
  background:#d32f2f;
  color:#fff;
}

#comment-input {
  width:100%;
  min-height:100px;
  padding:10px;
  border:2px solid #ddd;
  border-radius:8px;
  font-size:14px;
  resize:vertical;
  box-sizing:border-box;
  font-family:inherit;
}

#char-count {
  text-align:right;
  font-size:12px;
  color:#666;
  margin-top:4px;
}

.modal-buttons {
  display:flex;
  gap:8px;
  margin-top:20px;
}

.modal-btn {
  flex:1;
  padding:12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  font-size:14px;
  transition:.2s;
}

.modal-btn.save {
  background:#4caf50;
  color:#fff;
}

.modal-btn.save:hover {
  background:#45a049;
}

.modal-btn.cancel {
  background:#f5f5f5;
  color:#333;
}

.modal-btn.cancel:hover {
  background:#e0e0e0;
}
</style>
</head>

<body>

<div id="progress">ÏôÑÎ£åÏú® 0%</div>
<button id="download-btn" class="action-btn">üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
<div id="loading">Ï≤òÎ¶¨ Ï§ë...</div>
<div id="map"></div>

<!-- Î∞©Î¨∏ Ï†ïÎ≥¥ Î™®Îã¨ -->
<div id="modal">
  <div id="modal-content">
    <div id="modal-title"></div>
    
    <div class="modal-section">
      <label>Î∞©Î¨∏ ÏÉÅÌÉú</label>
      <div class="status-buttons">
        <button class="status-btn not-visited" data-status="false">ÎØ∏Î∞©Î¨∏</button>
        <button class="status-btn visited" data-status="true">Î∞©Î¨∏ÏôÑÎ£å</button>
      </div>
    </div>
    
    <div class="modal-section">
      <label>ÏΩîÎ©òÌä∏ (500Ïûê Ïù¥ÎÇ¥)</label>
      <textarea id="comment-input" maxlength="500" placeholder="Î∞©Î¨∏ ÌõÑÍ∏∞ÎÇò Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
      <div id="char-count">0/500</div>
    </div>
    
    <div class="modal-buttons">
      <button class="modal-btn cancel">Ï∑®ÏÜå</button>
      <button class="modal-btn save">Ï†ÄÏû•</button>
    </div>
  </div>
</div>

<script>
// ============================================
// Firebase ÏÑ§Ï†ï
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyDjTcHpGJskJNkY-qLlU02A_yDe4fCZIaI",
  authDomain: "store-map-5cf8b.firebaseapp.com",
  projectId: "store-map-5cf8b",
  storageBucket: "store-map-5cf8b.firebasestorage.app",
  messagingSenderId: "805186031186",
  appId: "1:805186031186:web:694602e04ee9579189998b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ============================================
// Îß§Ïû• Îç∞Ïù¥ÌÑ∞ (41Í∞ú)
// ============================================
const stores = [
{num:1,name:"Ïö∏Î¶ºÌÑ∞ÎåÄÎ¶¨Ï†ê Íµ∞ÏûêÏó≠Ï†ê",address:"ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í¥ëÏßÑÍµ¨ Îä•ÎèôÎ°ú 297"},
{num:2,name:"Îã§ÏõêÎåÄÎ¶¨Ï†ê Ï§ëÍ≥°ÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ Í∏¥Í≥†ÎûëÎ°ú 115"},
{num:3,name:"Í¥ëÏû•ÎåÄÎ¶¨Ï†ê Ï§ëÍ≥°Ï†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ Î©¥Î™©Î°ú 160"},
{num:4,name:"Ïö∏Î¶ºÌÑ∞ÎåÄÎ¶¨Ï†ê Î≥∏Ï†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ ÏïÑÏ∞®ÏÇ∞Î°ú 220"},
{num:5,name:"Í¥ëÏû•ÎåÄÎ¶¨Ï†ê Íµ¨ÏùòÏ†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ ÏïÑÏ∞®ÏÇ∞Î°ú 415"},
{num:6,name:"Ïö∏Î¶ºÌÑ∞ÎåÄÎ¶¨Ï†ê Í±¥ÎåÄÏù¥ÎßàÌä∏Ï†ê",address:"ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í¥ëÏßÑÍµ¨ ÏïÑÏ∞®ÏÇ∞Î°ú 262"},
{num:7,name:"Ïö∏Î¶ºÌÑ∞ÎåÄÎ¶¨Ï†ê Íµ¨ÏùòÏó≠Ï†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ ÏûêÏñëÎ°ú 93"},
{num:8,name:"ÏïåÌååÎåÄÎ¶¨Ï†ê ÎÖ∏ÏõêÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÎÖ∏Ìï¥Î°ú 490"},
{num:9,name:"Ïã†Ï∞ΩÎåÄÎ¶¨Ï†ê Í≥µÎ¶âÏó≠Ï†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÎèôÏùºÎ°ú 1077"},
{num:10,name:"Í∞ÄÎä•ÎåÄÎ¶¨Ï†ê ÏÉÅÍ≥ÑÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÎèôÏùºÎ°ú 1379"},
{num:11,name:"PS&M (ÎßàÎì§Ïó≠Ï†ê)",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÎèôÏùºÎ°ú 1538"},
{num:12,name:"ÏÑúÏö∏entÎåÄÎ¶¨Ï†ê Í≥µÎ¶âÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÎèôÏùºÎ°ú192Í∏∏ 11"},
{num:13,name:"Ïã†Ï∞ΩÎåÄÎ¶¨Ï†ê ÎÖ∏ÏõêÏó≠ÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÏÉÅÍ≥ÑÎ°ú 75"},
{num:14,name:"ÏïåÌååÎåÄÎ¶¨Ï†ê ÏÑùÍ≥ÑÏó≠Ï†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÏÑùÍ≥ÑÎ°ú 4"},
{num:15,name:"Ïã†Ï∞ΩÎåÄÎ¶¨Ï†ê Í¥ëÏö¥ÎåÄÏ†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÏÑùÍ≥ÑÎ°ú 95"},
{num:16,name:"ACEÎåÄÎ¶¨Ï†ê ÏùÄÌñâÏÇ¨Í±∞Î¶¨Ï†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÌïúÍ∏ÄÎπÑÏÑùÎ°ú 254"},
{num:17,name:"ÏÑúÏö∏entÎåÄÎ¶¨Ï†ê ÏÉÅÍ≥ÑÏó≠Ï†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÌïúÍ∏ÄÎπÑÏÑùÎ°ú 384"},
{num:18,name:"ÏÉÅÎ°ùÏàòÎåÄÎ¶¨Ï†ê Ïö∞Ïû•ÏÇ∞Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í∞ïÏÑúÎ°ú 242"},
{num:19,name:"ÎèôÏßÑÎåÄÎ¶¨Ï†ê Í∞ïÏÑúÏ§ëÏïôÏ†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í∞ïÏÑúÎ°ú 279"},
{num:20,name:"ÎèôÏßÑÎåÄÎ¶¨Ï†ê ÍπåÏπòÏÇ∞Ïó≠ Î≥∏Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í∞ïÏÑúÎ°ú 63"},
{num:21,name:"Ï∞∏Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê Îì±Ï¥åÏ†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í∞ïÏÑúÎ°ú56Í∏∏"},
{num:22,name:"Ïã†ÎÇòÎäî ÎßàÍ≥°ÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í≥µÌï≠ÎåÄÎ°ú 168"},
{num:23,name:"Í∞ïÏÑúÎåÄÎ¶¨Ï†ê ÏóºÏ∞ΩÏó≠Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í≥µÌï≠ÎåÄÎ°ú 635"},
{num:24,name:"ÎèôÏßÑÎåÄÎ¶¨Ï†ê ÎßàÍ≥°Î≥∏Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í∞ïÏÑúÎ°ú 385"},
{num:25,name:"ÎèôÏßÑÎåÄÎ¶¨Ï†ê ÎßàÍ≥°ÎÇòÎ£®Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÎßàÍ≥°Ï§ëÏïôÎ°ú 161-17"},
{num:26,name:"Ï∞∏Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê Î∏îÎ£®ÎÇòÏù∏Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÏñëÏ≤úÎ°ú 583"},
{num:27,name:"ÌÅ∞ÏÇ¨ÎûëÎåÄÎ¶¨Ï†ê Î∞©ÌôîÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÏñëÏ≤úÎ°ú 73"},
{num:28,name:"PS&M (ÌôîÍ≥°Ïó≠Ï†ê)",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÌôîÍ≥°Î°ú 161,"},
{num:29,name:"ÏÑ∏ÌïòÎåÄÎ¶¨Ï†ê ÌôîÍ≥°Ïó≠Î≥∏Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÌôîÍ≥°Î°ú 190"},
{num:30,name:"ÎèôÏßÑÎåÄÎ¶¨Ï†ê ÌôîÍ≥°ÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÌôîÍ≥°Î°ú25Í∏∏ 2"},
{num:31,name:"ÎèôÏßÑÎåÄÎ¶¨Ï†ê Í∞ÄÏñëÏó≠ Î≥∏Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÌôîÍ≥°Î°ú68Í∏∏ 3"},
{num:32,name:"PS&M (Îì±Ï¥åÏó≠Ï†ê)",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Í≥µÌï≠ÎåÄÎ°ú 564"},
{num:33,name:"Í∞ïÏÑúÎåÄÎ¶¨Ï†ê Ïã†ÏõîÎ≥∏Ï†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ ÎÇ®Î∂ÄÏàúÌôòÎ°ú 354"},
{num:34,name:"Ï∞∏Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê Ïã†ÏõîÏ†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ ÎÇ®Î∂ÄÏàúÌôòÎ°ú 585"},
{num:35,name:"Ïú†ÏõêÎåÄÎ¶¨Ï†ê Î™©Îèô41ÌÉÄÏõåÏ†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Î™©ÎèôÎèôÎ°ú 293"},
{num:36,name:"ÌïúÏú†ÎåÄÎ¶¨Ï†ê Î™©ÎèôÍ¥ëÏû•ÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Î™©ÎèôÎèôÎ°ú 379"},
{num:37,name:"ÏÉàÏÑúÏö∏ÎåÄÎ¶¨Ï†ê Ïã†Ï†ïÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Î™©ÎèôÎèôÎ°ú 53"},
{num:38,name:"Ïú†ÏõêÎåÄÎ¶¨Ï†ê Î™©ÎèôÎ≥∏Ï†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Î™©ÎèôÏÑúÎ°ú 63"},
{num:39,name:"MDÎåÄÎ¶¨Ï†ê ÏóºÏ∞ΩÎèôÏßÅÏòÅÏ†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Î™©ÎèôÏ§ëÏïôÎ≥∏Î°ú 126"},
{num:40,name:"ÏÑ∏ÌïòÎåÄÎ¶¨Ï†ê Îì±Ï¥åÍπ®ÎπÑÏãúÏû•Ï†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Î™©ÎèôÏ§ëÏïôÎ∂ÅÎ°ú 29"},
{num:41,name:"ÏÑ∏Ìïò Ïã†Ï†ïÎ≥∏Ï†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Ï§ëÏïôÎ°ú 267"}
];

let storeData = {};
let currentStore = null;
let map;

// ============================================
// Firebase Ìï®ÏàòÎì§
// ============================================

async function loadDataFromFirebase() {
  try {
    const snapshot = await db.collection('stores41').get();
    snapshot.forEach(doc => {
      storeData[doc.id] = doc.data();
    });
    console.log('FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', Object.keys(storeData).length + 'Í∞ú');
    updateAllBubbles();
    updateProgress();
  } catch (error) {
    console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
  }
}

async function saveDataToFirebase(storeNum, data) {
  showLoading(true);
  try {
    await db.collection('stores41').doc(String(storeNum)).set(data);
    console.log(`Îß§Ïû• ${storeNum} Ï†ÄÏû• ÏôÑÎ£å`);
    showLoading(false);
  } catch (error) {
    console.error('Ï†ÄÏû• Ïã§Ìå®:', error);
    alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
    showLoading(false);
  }
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function updateAllBubbles() {
  Object.keys(storeData).forEach(num => {
    const bubble = document.getElementById(`b-${num}`);
    if (bubble && storeData[num].visited) {
      bubble.classList.add('visited');
    }
  });
}

// ============================================
// ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Í∏∞Îä•
// ============================================

function downloadExcel() {
  const excelData = [];
  excelData.push(['ÎÑòÎ≤Ñ', 'ÎåÄÎ¶¨Ï†ê Ïù¥Î¶Ñ', 'ÎåÄÎ¶¨Ï†ê Ï£ºÏÜå', 'ÏôÑÎ£å Ïó¨Î∂Ä', 'ÏΩîÎ©òÌä∏']);
  
  stores.forEach(store => {
    const data = storeData[store.num] || {visited: false, comment: ""};
    excelData.push([
      store.num,
      store.name,
      store.address,
      data.visited ? 'ÏôÑÎ£å' : 'ÎØ∏Î∞©Î¨∏',
      data.comment || ''
    ]);
  });
  
  const ws = XLSX.utils.aoa_to_sheet(excelData);
  ws['!cols'] = [
    {wch: 8},
    {wch: 30},
    {wch: 50},
    {wch: 12},
    {wch: 50}
  ];
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ÎåÄÎ¶¨Ï†ê Î∞©Î¨∏ ÌòÑÌô©');
  
  const today = new Date();
  const dateStr = `${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}`;
  const filename = `ÎåÄÎ¶¨Ï†ê_Î∞©Î¨∏ÌòÑÌô©_${dateStr}.xlsx`;
  
  XLSX.writeFile(wb, filename);
}

document.getElementById('download-btn').addEventListener('click', downloadExcel);

// ============================================
// Í∏∞Ï°¥ Ìï®ÏàòÎì§
// ============================================

function updateProgress(){
  const total = stores.length;
  const done = Object.values(storeData).filter(v=>v.visited).length;
  const percent = Math.round((done/total)*100);
  document.getElementById("progress").innerText =
    `ÏôÑÎ£åÏú® ${done}/${total} (${percent}%)`;
}

function openModal(storeNum){
  currentStore = storeNum;
  const store = stores.find(s => s.num === storeNum);
  const data = storeData[storeNum] || {visited: false, comment: ""};
  
  document.getElementById("modal-title").innerHTML = 
    `<div style="margin-bottom: 8px;">${store.num}. ${store.name}</div>
     <div style="font-size: 14px; color: #666; font-weight: normal;">${store.address}</div>`;
  
  document.querySelectorAll(".status-btn").forEach(btn => {
    btn.classList.remove("active");
    if(btn.dataset.status === String(data.visited)){
      btn.classList.add("active");
    }
  });
  
  const textarea = document.getElementById("comment-input");
  textarea.value = data.comment || "";
  updateCharCount();
  
  document.getElementById("modal").classList.add("show");
}

function closeModal(){
  document.getElementById("modal").classList.remove("show");
  currentStore = null;
}

async function saveModal(){
  const visitedBtn = document.querySelector(".status-btn.active");
  const visited = visitedBtn ? visitedBtn.dataset.status === "true" : false;
  const comment = document.getElementById("comment-input").value;
  
  const data = {visited, comment, updatedAt: new Date().toISOString()};
  storeData[currentStore] = data;
  
  await saveDataToFirebase(currentStore, data);
  
  const bubble = document.getElementById(`b-${currentStore}`);
  if(visited){
    bubble.classList.add('visited');
  } else {
    bubble.classList.remove('visited');
  }
  
  updateProgress();
  closeModal();
}

function updateCharCount(){
  const textarea = document.getElementById("comment-input");
  const count = textarea.value.length;
  document.getElementById("char-count").innerText = `${count}/500`;
}

document.querySelector(".modal-btn.cancel").addEventListener('click', closeModal);
document.querySelector(".modal-btn.save").addEventListener('click', saveModal);
document.getElementById("comment-input").addEventListener('input', updateCharCount);

document.querySelectorAll(".status-btn").forEach(btn => {
  btn.addEventListener("click", function(){
    document.querySelectorAll(".status-btn").forEach(b => b.classList.remove("active"));
    this.classList.add("active");
  });
});

document.getElementById("modal").addEventListener("click", function(e){
  if(e.target === this){
    closeModal();
  }
});

// ============================================
// Ïï± Ï¥àÍ∏∞Ìôî
// ============================================

async function initializeApp() {
  await loadDataFromFirebase();
  
  naver.maps.onJSContentLoaded = function(){
    map = new naver.maps.Map("map", {
      center: new naver.maps.LatLng(37.5665, 126.9780),
      zoom: 11
    });

    const bounds = new naver.maps.LatLngBounds();

    stores.forEach((store,index)=>{
      if (!storeData[store.num]) {
        storeData[store.num] = {visited: false, comment: ""};
      }

      setTimeout(()=>{
        naver.maps.Service.geocode(
          {query:store.address},
          function(status,res){
            if(status !== naver.maps.Service.Status.OK) return;

            const addr = res.v2.addresses[0];
            const pos = new naver.maps.LatLng(addr.y, addr.x);
            bounds.extend(pos);

            const isVisited = storeData[store.num].visited ? 'visited' : '';
            const content = `
              <div class="bubble ${isVisited}" id="b-${store.num}">
                ${store.num}. ${store.name}
              </div>
            `;

            const marker = new naver.maps.Marker({
              position: pos,
              map: map,
              icon:{
                content: content,
                anchor: new naver.maps.Point(50, 40)
              }
            });

            naver.maps.Event.addListener(marker,"click",()=>{
              openModal(store.num);
            });

            if(index === stores.length-1){
              map.fitBounds(bounds);
              updateProgress();
            }
          }
        );
      }, index*15);
    });
  };
  
  if (typeof naver !== 'undefined' && naver.maps) {
    naver.maps.onJSContentLoaded();
  }
}

window.addEventListener('DOMContentLoaded', initializeApp);
</script>

</body>
</html>
